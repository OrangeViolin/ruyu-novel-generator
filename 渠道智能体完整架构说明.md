# 📰 渠道智能体系统 - 完整功能架构说明

## 🎯 核心概念

**渠道智能体（Channel Agent）** = 每个公众号的"虚拟副主编"

它不仅知道该投什么，还知道编辑的"雷点"和"爽点"。

---

## 🧬 五维DNA拆解法（已实现✅）

当用户上传一个渠道（如"武志红"）的10-20篇历史文章时，智能体自动进行五维拆解：

### 1️⃣ 标题逻辑层
- **分析标题类型**：冲突型、共鸣型、知识悬念型
- **提取高频词汇**：如武志红的"潜意识"、"原生家庭"、"自我边界"
- **识别标题模式**：疑问句式、数字标题、对比式

### 2️⃣ 叙事结构层
识别文章的"骨架"：

**武志红风示例**：
```
典型引子（社会热点/影视剧）
    ↓
心理学案例（具象化描写）
    ↓
深度剖析（理论支撑）
    ↓
疗愈建议/金句
```

**数据结构**：
```json
{
  "sections": ["引入", "案例", "分析", "升华"],
  "case_ratio": 0.4,
  "theory_ratio": 0.4,
  "action_ratio": 0.2
}
```

### 3️⃣ 情绪调性层
识别文风标签：
- 冷静专业
- 温柔治愈
- 犀利毒舌
- 中产焦虑

### 4️⃣ 文本特征层
- 平均句长
- 段落密度
- 人称习惯（"你" vs "我们"）
- 词汇偏好

### 5️⃣ 互动/结尾层
- 引导评论区的逻辑
- 结尾的仪式感
- 行动建议

**✅ 已实现数据存储**：
```python
# 数据库字段
title_style = Column(JSON)      # 标题风格
content_structure = Column(JSON) # 内容结构
writing_style = Column(JSON)    # 文风特征
vocabulary_features = Column(JSON) # 词汇特征
topic_preferences = Column(JSON) # 话题偏好
```

---

## 🔄 智能体训练配置流程

### 第一步：语料喂养区（Data Feeding）✅

**当前实现**：
- ✅ 支持多格式上传：`.txt`、`.md` 文件
- ✅ 批量上传：可一次上传多个文件
- ✅ 文件存储：`uploads/corpus/` 目录
- ✅ 字数统计：自动统计语料总字数

**界面**：
```
┌─────────────────────────────────────┐
│ 📤 上传训练语料            [✕]      │
├─────────────────────────────────────┤
│ 选择智能体：[武志红公众号]          │
│                                     │
│ 上传语料文件 (.txt / .md)          │
│ ┌─────────────────────────────┐   │
│ │   📁 拖拽文件到此处或点击上传 │   │
│ │   支持多个.txt和.md文件      │   │
│ │   建议上传10-50篇该渠道范文  │   │
│ └─────────────────────────────┘   │
│                                     │
│ 📄 文章1.txt          25.3 KB       │
│ 📄 文章2.txt          18.7 KB       │
│ 📄 文章3.md          32.1 KB       │
│                                     │
│              [取消] [开始训练]      │
└─────────────────────────────────────┘
```

**待增强功能**：
- ⏳ 支持导入公众号链接（自动抓取文章）
- ⏳ 支持PDF文件导入
- ⏳ AI自动清洗（去除广告、版权声明）
- ⏳ 内容质量检测（去除无效内容）

### 第二步：智能画像生成（Channel Profiling）⏳

**AI分析流程**：
```
1. 读取上传的语料文件
2. 调用DeepSeek AI进行五维分析
3. 生成JSON格式的风格特征
4. 存储到数据库
```

**AI训练提示词**（已实现）：
```python
analysis_prompt = f"""分析以下公众号语料风格，以JSON格式返回特征：

{语料内容[:10000]}

请提取：
- title_style: 标题风格特征
- topic_preferences: 话题偏好
- writing_style: 文风特征
- content_structure: 内容结构
- length_requirements: 字数要求
- vocabulary_features: 词汇特征"""
```

**渠道画像报告示例**（待实现UI）：
```
📊 武志红公众号 - AI分析报告

✅ 语料统计
- 上传文件：25篇
- 总字数：78,543字
- 平均字数：3,142字/篇

🎯 风格特征
【标题风格】
- 类型：共鸣型、知识悬念型（80%）
- 高频词：潜意识、原生家庭、边界、投射
- 标题长度：平均15-20字

【叙事结构】
- 典型结构：热点引入 → 案例 → 深度分析 → 金句升华
- 案例占比：40%
- 理论分析：40%
- 行动建议：20%

【文风特征】
- 调性：温柔治愈、专业温暖
- 人称：多用"你"（第二人称）
- 句式：中等长度，有哲理感
- 段落：2-3句话一段，密度适中

【话题偏好】
- 核心话题：亲密关系、情绪管理、自我认知
- 权重：亲密关系(0.8)、原生家庭(0.7)、个人成长(0.6)

【词汇特征】
- 常用词：潜意识、投射、边界、接纳、觉察
- 避免词：神经症、变态、治疗师说教

【字数要求】
- 范围：2000-5000字
- 最佳：3000字左右
```

**待增强功能**：
- ⏳ 用户可手动微调AI分析结果
- ⏳ 可视化展示渠道画像
- ⏳ 支持导出分析报告

### 第三步：Prompt自动固化 ✅

**实现原理**：
```python
# 训练完成后，生成渠道专属Prompt
def generate_channel_prompt(agent):
    return f"""你是{agent.name}的特约作者。

【渠道风格要求】
- 文风：{agent.writing_style['tone']}
- 结构：{agent.content_structure['sections']}
- 字数：{agent.length_requirements['min']}-{agent.length_requirements['max']}字

【话题偏好】
{agent.topic_preferences}

【词汇要求】
- 常用：{agent.vocabulary_features['common_terms']}
- 避免：{agent.vocabulary_features['avoid_terms']}

请严格按照以上风格要求撰写文章。"""
```

**✅ 已实现**：
- AI分析后自动提取风格特征
- 存储到数据库JSON字段
- 生成时自动应用风格约束

---

## 📝 定向生成工作流

### 完整使用路径

#### 1️⃣ 输入需求
用户提供一个模糊的想法：
```
我想写关于"职场隐形霸凌"
```

#### 2️⃣ 智能体过滤

**武志红智能体**会提醒：
```
💡 建议角度：
"我们要从霸凌者的潜意识投射角度切入，
探讨权力关系中的心理动力"
```

**视觉志智能体**会提醒：
```
💡 建议角度：
"我们要找3-5个扎心的职场案例，
用强烈情绪带出共鸣"
```

#### 3️⃣ 生成大纲

按照该渠道特有的结构生成大纲（用户确认）：

**武志红风大纲**：
```
1. 引入：从最近的职场热点事件切入
2. 案例：描述一个典型的隐形霸凌场景
3. 分析：从心理学角度解读霸凌者的动机
4. 深入：探讨被霸凌者的心理创伤
5. 升华：如何建立心理边界，保护自己
```

#### 4️⃣ 分章节生成

调用训练好的文风进行填充

#### 5️⃣ 成品导出至【我的项目】

**✅ 已实现**：
```javascript
// 生成后保存到项目
async function saveToProject() {
    const response = await fetch('/api/chapters', {
        method: 'POST',
        body: JSON.stringify({
            project_id: selectedProject,
            title: `投稿内容 - ${agentName}`,
            content: generatedContent
        })
    });
}
```

**待增强功能**：
- ⏳ 自动生成3-5个备选标题
- ⏳ 自动生成投稿信（给编辑的邮件）
- ⏳ 导出时附带渠道风格指南

---

## 🎯 投稿专项增强（待实现）

### 杀手锏功能 #1：洗稿风险检测

**功能说明**：
自动检查生成内容与原语料的重合度，确保原创性

**实现方案**：
```python
def check_plagiarism(generated_content, corpus_texts):
    """检查内容原创性"""
    # 1. 提取关键词
    # 2. 计算相似度
    # 3. 标记雷同段落
    # 4. 给出修改建议

    return {
        "originality_score": 0.85,  # 原创度评分
        "similar_paragraphs": [],    # 雷同段落
        "suggestions": []            # 修改建议
    }
```

**UI展示**：
```
📊 原创性检测

原创度：85分 ⭐⭐⭐⭐
✅ 内容与语料风格一致，但表达原创

⚠️ 发现2处需要调整：
- 第3段：案例描述与语料相似度较高
  建议：替换为不同的案例细节

- 第5段：金句与原文章重复
  建议：改写表达方式
```

### 杀手锏功能 #2：编辑视角自检

**功能说明**：
AI模拟该渠道编辑提出3个刁钻问题，引导用户修改

**实现方案**：
```python
def editor_review(content, agent_style):
    """模拟编辑审稿"""
    prompt = f"""你是{agent.name}的编辑，
    请对以下稿件提出3个最刁钻的问题，
    从编辑角度审视这篇稿件是否达到发表标准：

    {content}

    请关注：
    1. 案例是否新颖？
    2. 论点是否深刻？
    3. 文风是否匹配？"""

    return ai_client.chat(prompt)
```

**UI展示**：
```
📝 编辑审稿意见

💬 编辑提问1：
"这个案例是否太陈旧？类似的职场故事
 我们已经发过很多篇了。"

💬 编辑提问2：
"心理学分析不够深入，只是停留在
 表面现象的描述，缺少对潜意识动
 力的挖掘。"

💬 编辑提问3：
"结尾的行动建议太笼统了，读者看
 完不知道具体该怎么做。"

[✅ 我已修改好] [🔄 重新生成]
```

---

## 🎨 UI/UX 逻辑

### 渠道智能体列表页

```
┌──────────────────────────────────────────────────┐
│ 📰 渠道投稿智能体                    [+ 创建智能体] │
│ 为不同公众号/渠道定制专属AI投稿助手               │
├──────────────────────────────────────────────────┤
│ [全部] [💕情感] [📖故事] [👶育儿] [💼职场] [🧠心理]│
├──────────────────────────────────────────────────┤
│                                                │
│ ┌──────────────────────────────────────────┐  │
│ │ 🧠 武志红公众号          深度匹配 ⭐⭐⭐  │  │
│ │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │  │
│ │ ✅ 已训练 | 📊 语料25篇 | 💰 稿费1500元/篇│  │
│ │                                         │  │
│ │ 📧 wzh_tougao@163.com                   │  │
│ │                                         │  │
│ │ [亲密关系] [情绪管理] [自我认知]        │  │
│ │                                         │  │
│ │ [✨ 生成内容] [📤 继续喂养] [⚙️ 编辑]   │  │
│ └──────────────────────────────────────────┘  │
│                                                │
│ ┌──────────────────────────────────────────┐  │
│ │ 📖 洞见                 待更新 ⏳       │  │
│ │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │  │
│ │ ⏳ 待训练 | 📊 语料5篇  | 💰 稿费500元/篇│  │
│ │                                         │  │
│ │ 📧 tougao@xxx.com                       │  │
│ │                                         │  │
│ │ [真实经历] [人物故事] [成长历程]        │  │
│ │                                         │  │
│ │ [📤 上传语料] [⚙️ 编辑] [🗑️]          │  │
│ └──────────────────────────────────────────┘  │
│                                                │
│ ┌──────────────────────────────────────────┐  │
│ │ 📖 十点读书              已就绪 ✅       │  │
│ │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │  │
│ │ ✅ 已训练 | 📊 语料18篇 | 💰 稿费800元/篇│  │
│ │                                         │  │
│ │ [✨ 生成内容] [📤 继续喂养] [⚙️ 编辑]   │  │
│ └──────────────────────────────────────────┘  │
└──────────────────────────────────────────────────┘
```

### 智能体详情页（待实现）

```
┌──────────────────────────────────────────────────┐
│ 🧠 武志红公众号 - 智能体详情                     │
├──────────────────────────────────────────────────┤
│                                                │
│ 【基本信息】                                    │
│ 渠道类型：🧠 心理类                             │
│ 目标受众：25-45岁关注心理健康的都市人群          │
│ 投稿邮箱：wzh_tougao@163.com                    │
│ 稿费标准：1500元/篇                             │
│                                                │
│ 【训练状态】                                    │
│ ✅ 已完成训练（2024-01-11）                     │
│ 📊 已分析25篇文章，共78,543字                   │
│                                                │
│ 【五维画像】                                    │
│ ┌────────────────────────────────────────────┐ │
│ │ 📌 标题风格                                │ │
│ │ • 类型：共鸣型、知识悬念型（80%）          │ │
│ │ • 高频词：潜意识、原生家庭、边界、投射      │ │
│ │ • 长度：平均15-20字                        │ │
│ └────────────────────────────────────────────┘ │
│                                                │
│ ┌────────────────────────────────────────────┐ │
│ │ 🏗️ 叙事结构                               │ │
│ │ • 典型结构：热点→案例→分析→升华           │ │
│ │ • 案例占比：40%                           │ │
│ │ • 理论分析：40%                           │ │
│ │ • 行动建议：20%                           │ │
│ └────────────────────────────────────────────┘ │
│                                                │
│ ┌────────────────────────────────────────────┐ │
│ ✍️ 文风特征                                │ │
│ │ • 调性：温柔治愈、专业温暖                │ │
│ │ • 人称：多用"你"（第二人称）              │ │
│ │ • 句式：中等长度，有哲理感                │ │
│ └────────────────────────────────────────────┘ │
│                                                │
│ 【操作】                                      │
│ [✨ 生成投稿内容] [📤 继续喂养语料] [📊 查看分析] │
│ [📝 编辑画像] [🗑️ 删除智能体]                   │
└──────────────────────────────────────────────────┘
```

### 【我的项目】流转

```
生成流程：
┌─────────────┐
│ 选择智能体   │
│ 武志红公众号 │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 输入主题     │
│ 职场霸凌     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ AI生成初稿   │
│ (自动符合   │
│  武志红风)  │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────┐
│ 导入【我的项目】            │
│ • 标记"待人工润色"          │
│ • 自动生成3个备选标题       │
│ • 附带渠道风格指南          │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 进入编辑器                  │
│ • 左边：AI文稿              │
│ • 右边：渠道风格指南        │
│ • 可对比修改                │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 终稿导出                    │
│ • 复制到剪贴板              │
│ • 发送至投稿邮箱            │
└─────────────────────────────┘
```

---

## 📊 实现状态总览

### ✅ 已完成功能

| 模块 | 功能 | 状态 |
|------|------|------|
| 数据模型 | ChannelAgent数据模型 | ✅ 100% |
| 数据导入 | Word文档解析导入 | ✅ 100% |
| 基础API | CRUD操作 | ✅ 100% |
| 语料上传 | 支持txt/md多文件 | ✅ 100% |
| AI训练 | 五维风格分析 | ✅ 100% |
| 内容生成 | 基于风格生成文章 | ✅ 100% |
| 项目集成 | 导入到【我的项目】 | ✅ 100% |
| 联系信息 | 邮箱、稿费信息 | ✅ 100% |
| 前端界面 | 基础管理界面 | ✅ 90% |

### ⏳ 待增强功能

| 模块 | 功能 | 优先级 | 预估工作量 |
|------|------|--------|-----------|
| 语料上传 | 公众号链接抓取 | 高 | 2天 |
| 语料清洗 | 自动去除广告/版权 | 高 | 1天 |
| 智能画像 | 可视化分析报告 | 中 | 2天 |
| 用户交互 | 手动微调画像 | 中 | 1天 |
| 标题生成 | 多标题备选 | 高 | 0.5天 |
| 投稿信 | 自动生成邮件 | 中 | 0.5天 |
| 原创检测 | 洗稿风险检测 | 高 | 2天 |
| 编辑自检 | AI模拟审稿 | 中 | 1天 |
| 详情页 | 完整画像展示 | 中 | 2天 |
| 对比编辑 | 双栏编辑器 | 低 | 2天 |

---

## 🚀 快速上手指南

### 1. 创建智能体（已导入20个）

系统已从Word文档导入20个渠道智能体：
- 🧠 武志红公众号（心理学）
- 💕 婚姻与家庭杂志
- 📖 真实故事计划（6个故事类）
- 📝 通用类（12个）

### 2. 训练智能体

```
1. 进入"📰 渠道智能体"页面
2. 选择智能体（如"武志红公众号"）
3. 点击"📤 上传语料"
4. 选择10-20篇该公众号的历史文章（.txt或.md）
5. 点击"开始训练"
6. 等待AI分析（1-3分钟）
7. 训练完成，状态变为"✅ 已训练"
```

### 3. 生成投稿内容

```
1. 在已训练的智能体上点击"✨ 生成内容"
2. 输入文章主题（如"职场隐形霸凌"）
3. 选择目标项目（可选）
4. 点击"🚀 开始生成"
5. 等待生成（1-2分钟）
6. 预览生成结果
7. 保存到项目或直接复制
```

### 4. 人工润色投稿

```
1. 进入"我的项目"
2. 打开保存的文章
3. 参考渠道风格指南进行润色
4. 完成后复制到投稿邮箱
```

---

## 💡 最佳实践建议

### 语料准备
- ✅ **数量**：10-50篇，建议20-30篇
- ✅ **质量**：选择该渠道的头条文章
- ✅ **时间**：最近3-6个月的文章（风格更稳定）
- ✅ **格式**：.txt纯文本最好，去除广告和图片

### 训练建议
- ✅ **首次训练**：上传完整语料一次性训练
- ✅ **持续优化**：定期添加新文章，重新训练
- ✅ **风格微调**：根据AI分析结果手动调整

### 生成技巧
- ✅ **主题明确**：提供清晰的主题方向
- ✅ **结合热点**：输入当前社会热点话题
- ✅ **参考案例**：提供具体案例或故事线索
- ✅ **多次生成**：同一主题可多次生成，选择最佳版本

---

## 🎯 系统架构图

```
┌─────────────────────────────────────────────────────────┐
│                    渠道智能体系统                          │
└─────────────────────────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        ▼                 ▼                 ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│  语料上传     │  │  AI训练      │  │  内容生成     │
│              │  │              │  │              │
│ • .txt/md    │  │ • 五维分析   │  │ • 风格匹配   │
│ • 批量上传   │  │ • 特征提取   │  │ • 大纲生成   │
│ • 自动统计   │  │ • Prompt固化│  │ • 内容填充   │
└──────┬───────┘  └──────┬───────┘  └──────┬───────┘
       │                 │                 │
       └─────────────────┼─────────────────┘
                         │
                         ▼
              ┌──────────────────────┐
              │   SQLite数据库       │
              │                      │
              │ • channel_agents表  │
              │ • 风格特征JSON       │
              │ • 训练状态           │
              └──────────────────────┘
                         │
                         ▼
              ┌──────────────────────┐
              │   【我的项目】       │
              │                      │
              │ • 章节存储           │
              │ • 人工编辑           │
              │ • 投稿导出           │
              └──────────────────────┘
```

---

## 🔮 未来规划

### Phase 1：基础完善（当前）
- ✅ 数据模型和API
- ✅ 语料上传和训练
- ✅ 内容生成和导出
- ⏳ UI优化和细节完善

### Phase 2：智能增强（下个版本）
- ⏳ 公众号链接自动抓取
- ⏳ AI自动清洗语料
- ⏳ 原创性检测
- ⏳ 编辑视角自检

### Phase 3：生态构建
- ⏳ 智能体市场（用户可分享训练好的智能体）
- ⏳ 社区协作（多人共同训练一个智能体）
- ⏳ 数据统计（过稿率、稿费追踪）

---

**📚 相关文档**：
- CHANNEL_AGENTS_20_SUCCESS.md - 20个智能体完整列表
- backend/api/app.py - API实现
- frontend/static/js/channel-agents.js - 前端逻辑

**🎉 立即体验**：访问 http://127.0.0.1:8000 → 渠道智能体
